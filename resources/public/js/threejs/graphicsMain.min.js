Detector.webgl||(Detector.addGetWebGLMessage(),document.getElementById("graphics-container").innerHTML="");
var PLANET_PARAMETERS={earth:{name:"EARTH",radius:6371,textures_HIGHRES:{mainTexture:"img/NASA_earth_july_HIGHRES.png",bumpMap:"img/NASA_earth_bump_HIGHRES.png"},textures_LOWRES:{mainTexture:"img/NASA_earth_july_LOWRES.png",bumpMap:"img/NASA_earth_bump_LOWRES.png"},ambientLight:.4,starLight:1},jupiter:{name:"JUPITER",radius:69911,textures_LOWRES:{mainTexture:"img/4kjupiter.jpg"},ambientLight:.2,starLight:.8},mars:{name:"MARS",radius:3389.5,textures_LOWRES:{mainTexture:"img/MarsV3-Shaded-2k.jpg"},
ambientLight:.5,starLight:1.2}};function toggleObjectsVisible(a){a.forEach(function(a){a.visible=!a.visible})}function toggleMeridians(){toggleObjectsVisible(meridians)}function toggleSatellites(){toggleObjectsVisible(satelliteMeshes)}function toggleSatelliteConnections(){toggleObjectsVisible(satelliteConnections)}function toggleCoordinateAxes(){axisHelper.visible=!axisHelper.visible;axisHelperNeg.visible=!axisHelperNeg.visible}
function toggleSolutionPath(){var a=satellitesGUI.showShortestPath?65280:16737792;connectionPath.forEach(function(b){b.material.color.setHex(a)})}function toggleMoveEndpoints(a){a?($("#graphics-container").on("mousemove",onMouseMove),start.material.emissiveIntensity=1,end.material.emissiveIntensity=1):($("#graphics-container").off("mousemove"),start.material.emissiveIntensity=0,end.material.emissiveIntensity=0)}function removeGraphicsObjects(a){a.forEach(function(a){scene.remove(a)})}
var scene,camera,renderer,gui,controls,stats;
function init(){scene=new THREE.Scene;var a=window.innerWidth,b=window.innerHeight;camera=new THREE.PerspectiveCamera(70,a/b,1,1E6);camera.up=new THREE.Vector3(0,0,1);renderer=new THREE.WebGLRenderer;renderer.setSize(a,b);document.getElementById("graphics-container").appendChild(renderer.domElement);loadGUI();loadPlanet(PLANET_PARAMETERS.earth);controls=new THREE.OrbitControls(camera,renderer.domElement);stats=new Stats;stats.showPanel(0);$("#stats-container").append(stats.dom)}var satellitesGUI;
function loadGUI(){satellitesGUI=new function(){this.satelliteCount=5;this.minAltitude=300;this.maxAltitude=700;this.generateSatellites=function(){$.getJSON("generator.json",{satelliteCount:this.satelliteCount,minAltitude:this.minAltitude,maxAltitude:this.maxAltitude,planetRadius:PLANET_PARAMETERS[this.planetName.toLowerCase()].radius,start:start.position.toArray(),end:end.position.toArray()},function(a){loadSatellites(a)})};this.altitude=0;this.polyhedron="cube";this.generateConstellation=function(){$.getJSON("generator.json",
{polyhedron:this.polyhedron,altitude:this.altitude,planetRadius:PLANET_PARAMETERS[this.planetName.toLowerCase()].radius,start:start.position.toArray(),end:end.position.toArray()},function(a){loadSatellites(a)})};this.moveEndpointsMode=!1;this.showShortestPath=this.showConnections=this.showSatellites=!0;this.planetName="Earth";this.showMeridians=this.showAxes=!1;this.redraw=function(a){for(;0<scene.children.length;)scene.remove(scene.children[0]);controls.reset();switch(a){case "Jupiter":console.log("redraw Jupiter");
loadPlanet(PLANET_PARAMETERS.jupiter);break;case "Mars":console.log("redraw Mars");loadPlanet(PLANET_PARAMETERS.mars);break;default:console.log("redraw default: Earth"),loadPlanet(PLANET_PARAMETERS.earth)}}};gui=new dat.GUI({autoPlace:!1,width:300});$("#gui-container").append(gui.domElement);var a=gui.addFolder("Satellites");a.add(satellitesGUI,"showSatellites").onChange(toggleSatellites);a.add(satellitesGUI,"showConnections").onChange(toggleSatelliteConnections);a.add(satellitesGUI,"showShortestPath").onChange(toggleSolutionPath);
var b=a.addFolder("Random generation"),a=a.addFolder("Constellations");b.add(satellitesGUI,"satelliteCount",0,100).step(1);b.add(satellitesGUI,"minAltitude",0,49999).step(1);b.add(satellitesGUI,"maxAltitude",1,5E4).step(1);b.add(satellitesGUI,"generateSatellites");a.add(satellitesGUI,"altitude",0,5E4).step(1);a.add(satellitesGUI,"polyhedron",["tetrahedron","cube","octahedron","dodecahedron","icosahedron"]);a.add(satellitesGUI,"generateConstellation");gui.addFolder("Move endpoints").add(satellitesGUI,
"moveEndpointsMode").onChange(toggleMoveEndpoints);b=gui.addFolder("Planet");b.add(satellitesGUI,"planetName",["Earth","Mars","Jupiter"]).onChange(satellitesGUI.redraw);b.add(satellitesGUI,"showAxes").onChange(toggleCoordinateAxes);b.add(satellitesGUI,"showMeridians").onChange(toggleMeridians);console.log("controls loaded")}var satelliteMeshes=[],satelliteConnections=[],connectionPath=[];
function loadSatellites(a){0<satelliteMeshes.length&&(removeGraphicsObjects(satelliteMeshes),satelliteMeshes=[]);0<satelliteConnections.length&&(removeGraphicsObjects(satelliteConnections),satelliteConnections=[]);0<connectionPath.length&&(removeGraphicsObjects(connectionPath),connectionPath=[]);var b,c,d=new THREE.Vector3(0,0,0);a.nodes.forEach(function(a,e){b="START"===a.name||"END"===a.name?new THREE.BoxGeometry(0,0,0):new THREE.BoxGeometry(150,150,150);c=new THREE.MeshLambertMaterial({color:13369497});
var g=new THREE.Mesh(b,c);g.name=a.name;g.position.fromArray(a.pos);g.visible=satellitesGUI.showSatellites;g.lookAt(d);satelliteMeshes.push(g);scene.add(g)});satelliteConnections.needsServerUpdate=!1;var e;a.edges.forEach(function(a,b){e=new THREE.Geometry;e.vertices.push((new THREE.Vector3).fromArray(a[0].pos),(new THREE.Vector3).fromArray(a[1].pos));var c=new THREE.LineBasicMaterial({color:16737792}),c=new THREE.Line(e,c);c.visible=satellitesGUI.showConnections;a[3].is_solution_path&&connectionPath.push(c);
satelliteConnections[b]=c;scene.add(c)});satellitesGUI.showShortestPath&&toggleSolutionPath();console.log("satellites loaded")}var planet;
function loadPlanet(a){var b=0;a.radius&&(b=a.radius);var c=new THREE.SphereGeometry(b,32,32),d,e=new THREE.TextureLoader,f=a.textures_LOWRES;f.mainTexture?(d=new THREE.MeshPhongMaterial({map:e.load(f.mainTexture)}),console.log("planet texture loaded")):(console.warn("no texture for planet found, rendering with empty texture"),d=new THREE.MeshPhongMaterial);f.bumpMap&&(d.bumpMap=e.load(f.bumpMap),d.bumpScale=.02*b);f.specularMap&&(d.specularMap=e.load(f.specularMap));f.normalMap&&(d.normalMap=e.load(f.normalMap));
planet=new THREE.Mesh(c,d);planet.planetName=a.name;c=.5*Math.PI;planet.rotateY(-1.525);planet.rotateY(c);planet.rotateX(c);camera.position.x=1.5*b;camera.position.y=1.5*b;camera.position.z=0;scene.add(planet);loadMeridians(a.radius);loadCoordinateAxes(a.radius);loadEndpoints(a.radius,planet);loadLights(a.radius,a.ambientLight,a.starLight);console.log(a.name+" loaded")}var meridians=[];
function loadMeridians(a){a*=1.01;a=new THREE.EllipseCurve(0,0,a,a,0,2*Math.PI,!1,0);var b=(new THREE.Path(a.getPoints(250))).createPointsGeometry(50),c=new THREE.LineBasicMaterial({color:16711935});a=new THREE.Line(b,c);b=new THREE.Line(b,c);b.rotateX(Math.PI/2);a.visible=b.visible=satellitesGUI.showMeridians;scene.add(a);scene.add(b);console.log("equator and prime meridian loaded");meridians.push(a);meridians.push(b)}var ambientLight,starLight;
function loadLights(a,b,c){ambientLight=new THREE.AmbientLight(16777215,b);scene.add(ambientLight);starLight=new THREE.PointLight(16777215,c,0);starLight.position.set(4*a,4*a,4*a);scene.add(starLight);console.log("lights loaded")}var axisHelper,axisHelperNeg;
function loadCoordinateAxes(a){axisHelper=new THREE.AxisHelper(3*a);axisHelper.visible=satellitesGUI.showAxes;axisHelperNeg=new THREE.AxisHelper(3*a);axisHelper.geometry.scale(-1,-1,-1);axisHelperNeg.visible=satellitesGUI.showAxes;scene.add(axisHelper);scene.add(axisHelperNeg);console.log("coordinate axes loaded")}var start,end;
function loadEndpoints(a,b){var c=new THREE.CylinderGeometry(a/120,0,a/20);c.rotateX(Math.PI/2);c.translate(0,0,125);var d=new THREE.MeshPhongMaterial({color:3381555,emissive:65280,emissiveIntensity:0}),e=new THREE.MeshPhongMaterial({color:255,emissive:65535,emissiveIntensity:0});start=new THREE.Mesh(c,d);end=new THREE.Mesh(c,e);"EARTH"===b.planetName?(c=new THREE.Vector3(3093.2,1314.1,5400),d=new THREE.Vector3(3768.8,747.6,5074.2)):(c=new THREE.Vector3(a,0,0),d=new THREE.Vector3(-a,0,0));start.position.set(0,
0,0);start.lookAt(c);start.position.copy(c);end.position.set(0,0,0);end.lookAt(d);end.position.copy(d);scene.add(start);scene.add(end);console.log("endpoints loaded")}var MOUSE_POS=new THREE.Vector2,DRAG_OBJECT={};
function onMouseMove(a){a.preventDefault();var b=$("#graphics-container"),c=a.clientX-b.offset().left;a=a.clientY-b.offset().top;MOUSE_POS.x=c/renderer.domElement.clientWidth*2-1;MOUSE_POS.y=2*-(a/renderer.domElement.clientHeight)+1;a=new THREE.Raycaster;a.setFromCamera(MOUSE_POS,camera);c=a.intersectObject(planet);if($.isEmptyObject(DRAG_OBJECT))if(a=a.intersectObjects([start,end]),0<a.length&&0<c.length)a[0].object.material.emissiveIntensity=0,controls.enabled&&(controls.enabled=!1,$("#graphics-container").on("mousedown",
onMouseDownDrag),$("#graphics-container").on("mouseup",onMouseUpDrag));else{if($.isEmptyObject(DRAG_OBJECT)&&!controls.enabled&&(controls.enabled=!0,$("#graphics-container").off("mousedown"),$("#graphics-container").off("mouseup"),satelliteMeshes.needsServerUpdate)){var d=[];satelliteMeshes.forEach(function(a){var b;b="START"===a.name?start.position.toArray():"END"===a.name?end.position.toArray():a.position.toArray();d.push({name:a.name,pos:b})});c={planetRadius:PLANET_PARAMETERS[satellitesGUI.planetName.toLowerCase()].radius,
satellites:d};c=JSON.stringify(c);$.getJSON("solve.json",c,function(a){a.parseError?console.warn("solve.json ERROR: ",a.parseError):loadSatellites(a)});satelliteMeshes.needsServerUpdate=!1}1>start.material.emissiveIntensity&&(start.material.emissiveIntensity=1);1>end.material.emissiveIntensity&&(end.material.emissiveIntensity=1)}else 0<c.length&&(DRAG_OBJECT.pointer.position.set(0,0,0),c=c[0],a=c.face.normal,a=new THREE.Vector3(a.x,-a.z,a.y),DRAG_OBJECT.pointer.lookAt(a),DRAG_OBJECT.pointer.position.copy(c.point),
satelliteMeshes.needsServerUpdate=!0)}function onMouseDownDrag(){var a=new THREE.Raycaster;a.setFromCamera(MOUSE_POS,camera);var b=a.intersectObjects([start,end]),a=a.intersectObject(planet);0<b.length&&(DRAG_OBJECT.pointer=b[0].object);0<a.length&&(DRAG_OBJECT.planetMesh=a[0])}function onMouseUpDrag(){DRAG_OBJECT={}}function render(){requestAnimationFrame(render);stats.begin();renderer.render(scene,camera);stats.end()}
window.addEventListener("resize",function(){renderer.setSize(window.innerWidth,window.innerHeight);camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix()});init();render();
